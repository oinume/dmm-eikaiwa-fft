machine:
  environment:
    GOPATH: "${HOME}/.go_workspace"
    GOROOT: "${HOME}/go"
    GOBIN: "${GOPATH}/bin"
    GO_VERSION: "1.8"
    GOPATH_PROJECT: "${GOPATH}/src/github.com/oinume/lekcije"
    PATH: "${GOPATH}/bin:${HOME}/go/bin:${PATH}"
    MYSQL_USER: "lekcije"
    MYSQL_PASSWORD: "lekcije"
    MYSQL_HOST: "127.0.0.1"
    MYSQL_PORT: "3306"
    MYSQL_DATABASE: "lekcije_test"
    REDIS_URL: "redis://h:@127.0.0.1:6379"
    E2E_WEB_DRIVER: "PhantomJS"
    VERSION_HASH: "_version_"
  services:
    - mysql
    - redis
dependencies:
  pre:
    - echo "" > ~/.gitconfig
    - git config --global url."https://github.com".insteadOf git://github.com
    - git config --global http.https://gopkg.in.followRedirects true
    - cd $HOME && curl -O https://storage.googleapis.com/golang/go$GO_VERSION.linux-amd64.tar.gz
    - cd $HOME && tar xzf go$GO_VERSION.linux-amd64.tar.gz
    - go version
    - mysql -uroot -e "CREATE DATABASE IF NOT EXISTS lekcije_test DEFAULT CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_unicode_ci;"
    - mysql -uroot -e "GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER, LOCK TABLES ON \`lekcije\\_test%\`.* TO 'lekcije'@'%' IDENTIFIED BY 'lekcije'"
    - mkdir -p $(dirname ${GOPATH_PROJECT})
    - rm -rf ${GOPATH_PROJECT}
    - ln -s ~/lekcije ${GOPATH_PROJECT}
    - cd ${GOPATH_PROJECT} && make setup
    - cd ${GOPATH_PROJECT} && goose -env=circle_ci up
test:
  override:
    - cd ${GOPATH_PROJECT} && make go_lint
    - cd ${GOPATH_PROJECT} && make test
